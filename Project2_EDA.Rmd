---
title: "CMDA 4654 Project 2"
author: "Jamal Mani"
date: "2025-11-22"
fontsize: 9pt
classoption: "aspectratio=169"
output:
  beamer_presentation: 
    fonttheme: professionalfonts
    highlight: kate
    theme: Rochester
header-includes:
- \definecolor{VTmaroon}{HTML}{861F41}
- \usecolortheme[named=VTmaroon]{structure}
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE)

def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  paste0("\n \\", "footnotesize","\n\n", x, "\n\n \\normalsize")
})
```
## Main Dataset

This project uses the Burke et al. (2022) global urban soil black carbon dataset, obtained from the Knowledge Network for Biocomplexity (KNB) at:
https://knb.ecoinformatics.org/view/urn:uuid:1651eeb1-e050-4c78-8410-ec2389ca2363

The dataset pulls together measurements of black carbon in urban soils from cities around the world. Each row includes details like latitude/longitude, elevation, precipitation, soil temperature at different depths, land-cover type, population info, and notes from the original studies. The main sheet (“Urban Black Carbon”) contains 600+ observations and about 65 variables, giving us a wide mix of environmental and geographic predictors.

Because many of these variables move together (climate, location, soil traits, etc.), the dataset naturally has clusters of correlated features, which makes it a solid fit for demonstrating Least Angle Regression (LARS).

## Data Dictionary

```{r load-data, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(readxl)
library(tidyverse)
library(janitor)
library(skimr)
library(kableExtra)

soil_raw <- read_excel("Burke_soilBC_2022.xlsx",
                       sheet = "Urban Black Carbon")
```


```{r}
#clean col names to snake_case 
soil <- soil_raw %>%
  clean_names()


soil <- soil %>%
  mutate(across(
      c(urban_land_use, urban_land_cover_2),
      ~ na_if(.x, "-999")
    )
  )

missing_tbl <- soil %>%
  summarize(across(everything(), ~ mean(is.na(.)) * 100)) %>%
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "pct_missing") %>%
  arrange(desc(pct_missing))
```

```{r echo=F}
vars_keep <- missing_tbl %>%
  filter(pct_missing < 90) %>%
  pull(variable)

soil_reduced <- soil %>% select(all_of(vars_keep))
```


```{r include = FALSE}
response_var <- "bc_mg_g"

predictors <- c(
  "latitude_from_ge",
  "longitude_from_ge",
  "combined_elevation_masl",
  "combined_precipitation_mm_yr",
  "mean_annual_soil_temp_0_5_cm_c_1979_2013",
  "mean_annual_soil_temp_5_15_cm_c_1979_2013",
  "depth_cm",
  "depth_range_cm"
)

soil_model <- soil_reduced %>%
  select(all_of(c(response_var, predictors)))

#complete cases
soil_model_clean <- soil_model %>% 
  drop_na()

n_before <- nrow(soil_model)
n_after  <- nrow(soil_model_clean)

#fix depth range to numeric
soil_model_clean <- soil_model_clean %>%
  mutate(
    depth_range_cm = depth_range_cm %>%
      str_split("-", simplify = TRUE) %>%
      apply(1, \(x) mean(as.numeric(x)))
  )

#standardize predictors
soil_lars <- soil_model_clean %>%
  mutate(across(all_of(predictors), scale))
```



```{r echo=FALSE}
library(kableExtra)

data_dict <- tibble(
  variable = c(response_var, predictors),
  description = c(
    "Black carbon concentration (mg/g)",
    "Latitude of sample location",
    "Longitude of sample location",
    "Elevation (masl)",
    "Annual precipitation (mm/year)",
    "Annual mean soil temperature 0–5 cm (°C, 1979–2013)",
    "Annual mean soil temperature 5–15 cm (°C, 1979–2013)",
    "Sampling depth (cm)",
    "Depth range of sample (cm)"
  ),
  type = c("numeric", rep("numeric", length(predictors)))
)

data_dict %>%
  kable(
    format = "latex",
     booktabs = TRUE,
    caption = "Data Dictionary for Modeling Variables",
    col.names = c("Variable", "Description", "Type")
  ) %>%
  kable_styling(
    latex_options = c("hold_position")
  )
```
We removed variables with 90+% missing values to avoid unstable predictors and ensure consistent sample size across all variables. This threshold preserved essential environmental predictors while excluding sparse fields that contained too little information to contribute to modeling.




## BC vs Depth
```{r}
## bc vs depth
ggplot(soil_lars, aes(x = depth_cm, y = bc_mg_g)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", se = FALSE, color = "steelblue") +
  labs(
    title = "BC Concentration vs Sampling Depth",
    x = "Depth (cm)",
    y = "BC (mg/g)"
  ) +
  theme_minimal()
```

## Takeaways

- High BC values occur almost entirely near the surface (0–1 cm), reflecting strong urban deposition.

- BC drops sharply with depth, flattening to low levels beyond ~4 cm.

- Variance is very large at shallow depths, but nearly zero deeper in the profile.

- Pattern indicates a nonlinear depth–BC relationship and potential heteroskedasticity.

- Supports LARS: depth correlates with other environmental factors, and regularization helps stabilize selection in the presence of such gradients.

## Predictor Correlation Heatmap 

```{r}
# correlation matrix among standardized predictors
corr_mat <- soil_lars %>%
  select(all_of(predictors)) %>%
  cor()

corr_df <- as_tibble(
  expand.grid(
    var1 = rownames(corr_mat),
    var2 = colnames(corr_mat)
  )
) %>%
  mutate(correlation = as.vector(corr_mat))

ggplot(corr_df, aes(x = var1, y = var2, fill = correlation)) +
  geom_tile() +
  scale_fill_gradient2(limits = c(-1, 1)) +
  coord_fixed() +
  labs(
    title = "Correlation Among Predictors",
    x = NULL,
    y = NULL,
    fill = "r"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```



## Takeaways

- Strong spatial correlation between latitude and longitude.

- The two soil temperature variables are highly correlated.

- Elevation and precipitation follow the same environmental gradient.

- Overall: clear multicollinearity clusters, meaning several predictors share similar information. This supports using LARS.

